- name: Mise à jour des packages
  apt:
    name: "*"
    state: latest
    update_cache: yes

- shell: uname -r
  register: linux_flavour

- set_fact:
    linux_flavour={{ linux_flavour.stdout }}  

- name: Installation du pilote Nvidia
  apt:
    name: [ "linux-modules-nvidia-550-{{ linux_flavour }}", "nvidia-driver-550"]
    update_cache: yes
    state: present

- name: Chargement du pilote Nvidia
  community.general.modprobe:
    name: nvidia
    state: present

- name: Ajout de la clé OpenPGP du dépôt Nvidia
  get_url:
    url: https://nvidia.github.io/libnvidia-container/gpgkey
    dest: /etc/apt/keyrings/nvidia.asc

- name: Ajout du dépôt de paquets Nvidia
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/nvidia.asc] https://nvidia.github.io/libnvidia-container/stable/deb/$(ARCH) /"
    filename: nvidia.list
    state: present

- name: Installation de la librairie libnvidia-container
  apt:
    name: [ "nvidia-container-runtime" ]
    update_cache: yes
    state: present

- shell: "nvidia-smi -L | sed -e 's/.*UUID: //' -e 's/)//' | cut -d'-' -f1-2"
  register: gpu_uuid

- set_fact:
    gpu_uuid={{ gpu_uuid.stdout }}  

- include_role:
    name: geerlingguy.docker
  vars:
    docker_daemon_options:
      log-driver: fluentd
      log-opts:
        fluentd-address: localhost:24224
        tag: docker.txt.{{product_name}}.{{env_type}}.{{ '{{' }}.Name{{ '}}' }}_run
        fluentd-async: "true"
      dns: ["172.17.0.1"]
      runtimes:
        nvidia:
          path: "nvidia-container-runtime"
          runtimeArgs: []
      default-runtime: "nvidia"
      node-generic-resources: ["gpu={{ gpu_uuid }}"]

- shell: "docker node ls --format '{{ '{{' }} .ID {{ '}}' }}'"
  register: node_id

- set_fact:
    node_id={{ node_id.stdout }}  

- name: Ajout d'un label au nœud Docker Swarm
  shell: docker node update --label-add nvidia=true {{ node_id }}

