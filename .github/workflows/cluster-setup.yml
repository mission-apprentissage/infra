name: Cluster Setup
on:
  workflow_dispatch:
    inputs:
      cluster:
        description: The cluster to setup
        type: string
        required: true
      numbers:
        description: JSON environment array
        type: string
        required: true
        default: '[3, 2, 1]'
  workflow_call:
    inputs:
      cluster:
        type: string
        required: true
      numbers:
        type: string
        required: true
    secrets:
      DEPLOY_SSH_PRIVATE_KEY:
        description: SSH private key
        required: true
      DEPLOY_PASS:
        description: SSH PWD TO DEPLOY
        required: true
      SLACK_WEBHOOK_ALERTS:
        description: Slack webhook URL
        required: true
      SLACK_WEBHOOK_NOTIF:
        description: Slack webhook URL
        required: true
      VAULT_PWD:
        description: Vault Password
        required: true
      MONGODB_HABILITATIONS:
        description: Product habilitations
        required: true
      OVH_APP_TOKEN:
        description: OVH Application token
        required: true
      OVH_APP_KEY:
        description: OVH Application key
        required: true
      OVH_APP_SECRET:
        description: OVH Application secret
        required: true
      OPENPGP_PRIVATE_SUBKEY:
        description: Github Actions' OpenPGP private subkey
        required: true

jobs:
  setup:
    strategy:
      max-parallel: 1
      fail-fast: true
      matrix:
        n: ${{ fromJSON(inputs.numbers) }}
    name: Setup mongodb-${{ inputs.cluster }}-${{ matrix.n }}
    uses: "./.github/workflows/_setup.yml"
    with:
      product: mongodb
      environment: "${{ inputs.cluster }}_${{ matrix.n }}"
      SSH_KNOWN_HOSTS: ${{ vars.MONGODB_SSH_KNOWN_HOSTS }}
    secrets:
      DEPLOY_SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
      DEPLOY_PASS: ${{ secrets.DEPLOY_PASS }}
      SLACK_WEBHOOK_ALERTS: ${{ secrets.SLACK_WEBHOOK_ALERTS }}
      SLACK_WEBHOOK_NOTIF: ${{ secrets.SLACK_WEBHOOK_NOTIF }}
      VAULT_PWD: ${{ secrets.VAULT_PWD }}
      HABILITATIONS: ${{ secrets.MONGODB_HABILITATIONS }}
      OVH_APP_TOKEN: ${{ secrets.OVH_APP_TOKEN }}
      OVH_APP_KEY: ${{ secrets.OVH_APP_KEY }}
      OVH_APP_SECRET: ${{ secrets.OVH_APP_SECRET }}
      OPENPGP_PRIVATE_SUBKEY: ${{ secrets.MONGODB_OPENPGP_PRIVATE_SUBKEY }}
      TOKEN_MNA_SHARED: ${{ secrets.TOKEN_MNA_SHARED }}
